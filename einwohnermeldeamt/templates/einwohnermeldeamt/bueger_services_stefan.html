{% load static %}
<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link rel="stylesheet" href="{% static 'styletest.css' %}">
    <title>Bürgerservices</title>
    <style>
        #wohnsitz-section {
            display: none;
        }

        #standesamt-section {
            display: none;
        }
    </style>
</head>

<body>
    {% include "topbar.html" %}
    {% include "navbar.html" %}

    <h1>Bürgerservices</h1>

    {% if error %}
    <p><span class="warning bold">{{ error }}</span></p>
    {% endif %}


    {% if request.session.role == "mitarbeiter" %}
    <a class="button" href="{% url 'mitarbeiter_disable' %}">
        <p>Mitarbeiter-Modus beenden</p>
    </a>
    {% else %}
    <form method="POST" action="{% url 'mitarbeiter_enable' %}">
        {% csrf_token %}
        <label for="pin">Mitarbeiter-PIN</label>
        <input type="password" id="pin" name="pin" required>
        <button type="submit">Mitarbeiter-Modus aktivieren</button>
    </form>
    {% endif %}


    <form method="POST" action="{% url 'buerger_services' %}">
        {% csrf_token %}

        <label for="Formulare_Meldeamt">Formulare Meldeamt</label>
        <select id="Formulare_Meldeamt" name="Formulare_Meldeamt">
            <option value="">Formular auswählen</option>

            {% if request.session.role == "mitarbeiter" and request.session.mitarbeiter_rolle == "standesamt" %}
            <option value="standesamt">Standesamt</option>
            {% else %}
            <option value="wohnsitz">Wohnsitz anmelden</option>
            {% endif %}

        </select>


        <!-- WOHNSITZ -->
        <fieldset id="wohnsitz-section">
            <legend>Wohnsitz anmelden</legend>

            <label for="buerger_id">Bürger-ID:</label>
            <input type="text" id="buerger_id" name="buerger_id" required><br>

            <label for="adresse_id">Straße und Hausnummer:</label>
            <select id="adresse_id" name="adresse_id" required>
                <option value="">Adresse auswählen</option>
                {% for adr in adressen %}
                <option value="{{ adr.id }}">{{ adr.label }}</option>
                {% endfor %}
            </select>

            <button type="submit">Eingabe</button>

            <div id="map" style="width: 100%; height: 320px; margin-top: 12px; border-radius: 12px; overflow: hidden;">
            </div>

        </fieldset>

        <!-- STANDESAMT -->
        <fieldset id="standesamt-section">
            <legend>Standesamt</legend>

            <label for="namensaenderung_b_id1">
                Bürger-ID (Person, bei der der Nachname nicht geändert wird)
            </label>
            <input type="text" id="namensaenderung_b_id1" name="b_id_1" required><br>

            <label for="namensaenderung_b_id2">
                Bürger-ID (Person, bei der der Nachname geändert wird)
            </label>
            <input type="text" id="namensaenderung_b_id2" name="b_id_2" required><br>

            <label for="eheschliessungsdatum">Eheschließungsdatum:</label>
            <input type="date" id="eheschliessungsdatum" name="eheschliessungsdatum" required><br>

            <button type="submit">Eingabe</button>
        </fieldset>
    </form>

    <script>
        function hideNavbar() {
            document.querySelector(".navbar").classList.add("hidden");
        }

        const vorgangSelect = document.getElementById("Formulare_Meldeamt");

        const wohnsitzSection = document.getElementById("wohnsitz-section");
        const standesamtSection = document.getElementById("standesamt-section");

        const buergerIdInput = document.getElementById("buerger_id");
        const adresseSelect = document.getElementById("adresse_id");

        const bId1Input = document.getElementById("namensaenderung_b_id1");
        const bId2Input = document.getElementById("namensaenderung_b_id2");
        const eheDatumInput = document.getElementById("eheschliessungsdatum");

        function disableAll() {
            // Wohnsitz
            buergerIdInput.disabled = true;
            adresseSelect.disabled = true;

            // Standesamt
            bId1Input.disabled = true;
            bId2Input.disabled = true;
            eheDatumInput.disabled = true;
        }

        function hideAll() {
            wohnsitzSection.style.display = "none";
            standesamtSection.style.display = "none";
        }

        // Initialzustand: alles aus, damit required-Felder nicht blockieren
        disableAll();
        hideAll();

        vorgangSelect.addEventListener("change", function () {
            const auswahl = vorgangSelect.value;

            disableAll();
            hideAll();

            if (auswahl === "wohnsitz") {
                wohnsitzSection.style.display = "block";
                buergerIdInput.disabled = false;
                adresseSelect.disabled = false;
            }

            if (auswahl === "standesamt") {
                standesamtSection.style.display = "block";
                bId1Input.disabled = false;
                bId2Input.disabled = false;
                eheDatumInput.disabled = false;
            }
        });
    </script>

    <script>
        // --- MAPBOX SETUP ---
        mapboxgl.accessToken = "pk.eyJ1Ijoic29sZGllcmJveSIsImEiOiJjbWsxbXVxcXcwNXgxM2lwZWRjZDZ0NnhyIn0.igcNK41Hob6HDO5iJG1rvQ";

        const STUTTGART = [9.1829, 48.7758]; // [lng, lat]

        let map = null;
        let marker = null;

        function ensureMapInitialized() {
            if (map) return;

            map = new mapboxgl.Map({
                container: "map",
                style: "mapbox://styles/mapbox/streets-v12",
                center: STUTTGART,
                zoom: 12
            });

            marker = new mapboxgl.Marker().setLngLat(STUTTGART).addTo(map);
        }

        async function geocodeAndFly(addressText) {
            const query = encodeURIComponent(addressText + ", Germany");
            const url =
                `https://api.mapbox.com/geocoding/v5/mapbox.places/${query}.json` +
                `?access_token=${mapboxgl.accessToken}&limit=1`;

            const res = await fetch(url);
            if (!res.ok) return;

            const data = await res.json();
            if (!data.features || data.features.length === 0) return;

            const [lng, lat] = data.features[0].center;

            // Falls Map initialisiert ist, aber marker noch nicht (sehr selten)
            if (!marker) marker = new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
            else marker.setLngLat([lng, lat]);

            map.flyTo({ center: [lng, lat], zoom: 16, essential: true });
        }

        // --- Hook: nutzt eure EXISTIERENDEN Variablen aus dem 1. Script ---
        // (vorgangSelect und adresseSelect sind oben bereits definiert)

        vorgangSelect.addEventListener("change", function () {
            if (vorgangSelect.value === "wohnsitz") {
                // Karte erst initialisieren, wenn das Fieldset sichtbar ist
                setTimeout(() => {
                    ensureMapInitialized();
                    map.resize(); // wichtig, weil Container vorher display:none war
                }, 0);
            }
        });

        adresseSelect.addEventListener("change", function () {
            const opt = adresseSelect.options[adresseSelect.selectedIndex];
            const addressText = opt ? opt.textContent.trim() : "";
            if (!addressText || addressText === "Adresse auswählen") return;

            ensureMapInitialized();
            geocodeAndFly(addressText);
        });
    </script>


</body>

</html>